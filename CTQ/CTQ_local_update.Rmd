Prepare CTQ
```{r}
CTQ<-left_join(filter(cleaned_survey_data, grepl("CTQ",item)) %>%
                 filter(!is.na(value)) %>% 
                 filter(!value=="") %>%
                 filter(!grepl("TEXT",item)) %>%
                 mutate(value=as.numeric(value)) %>% 
                 distinct(tagid,item,value,survey_name,.keep_all = FALSE) %>% 
                 spread(item,value),
               redcap_cleaned %>%
                 filter(!is.na(dob),!is.na(sa_date)) %>%
                 dplyr::select(tagid, sa_date, sb_date, dob),by="tagid")

CTQ_Wave1<-left_join(CTQ,survey_date, by = c("tagid","survey_name")) %>% 
  distinct(tagid,survey_name,.keep_all = TRUE) %>%
  mutate(qualtrics_date=value) %>% 
  #select(-contains("TEXT")) %>%
  dplyr::select(-value)%>%
  mutate(survey_date=ifelse(survey_name=="TAG - Sess 2 - V1",sb_date,
                            ifelse(survey_name=="TAG - Sess 2 - V2",sb_date,
                                   ifelse(survey_name=="TAG - Sess 2 - V3 - Current",sb_date,
                                          ifelse(survey_name=="Sensitive Q's for 042",sb_date,as.character(qualtrics_date)
                                          ))))) %>%
  dplyr::select(-qualtrics_date,-sb_date,-sa_date,-dob) %>% 
  dplyr::select(-CTQ_1_2_1, -CTQ_2_2_1, -CTQ_3_2_1, -CTQ_4_2_1, -CTQ_5_2_1, -CTQ_6_2_1, 
         -CTQ_7_2_1, -CTQ_8_2_1, -CTQ_9_2_1, -CTQ_10_2_1, -CTQ_11_2_1, 
         -CTQ_12_2_1, -CTQ_13_2_1, -CTQ_14_2_1, -CTQ_15_2_1, -CTQ_16_2_1, 
         -CTQ_17_2_1, -CTQ_18_2_1, -CTQ_19_2_1, -CTQ_20_2_1, -CTQ_21_2_1, 
         -CTQ_22_2_1, -CTQ_23_2_1, -CTQ_24_2_1, -CTQ_25_2_1, -CTQ_26_2_1, 
         -CTQ_27_2_1, -CTQ_28_2_1, -CTQ_29_2_1, -CTQ_30_2_1, -CTQ_31_2_1, 
         -CTQ_32_2_1) %>% 
  mutate(CTQ_1=CTQ_1_1,
         CTQ_2=ifelse(CTQ_2_1==1,5,
                      ifelse(CTQ_2_1==2,4,
                             ifelse(CTQ_2_1==3,3,
                                    ifelse(CTQ_2_1==4,2,
                                           ifelse(CTQ_2_1==5,1,
                                                  NA))))),
         CTQ_3=CTQ_3_1,
         CTQ_4=CTQ_4_1,
         CTQ_5=ifelse(CTQ_5_1==1,5,
                      ifelse(CTQ_5_1==2,4,
                             ifelse(CTQ_5_1==3,3,
                                    ifelse(CTQ_5_1==4,2,
                                           ifelse(CTQ_5_1==5,1,
                                                  NA))))),
         CTQ_6=CTQ_6_1,
         CTQ_7=ifelse(CTQ_7_1==1,5,
                      ifelse(CTQ_7_1==2,4,
                             ifelse(CTQ_7_1==3,3,
                                    ifelse(CTQ_7_1==4,2,
                                           ifelse(CTQ_7_1==5,1,
                                                  NA))))),
         CTQ_8=CTQ_8_1,
         CTQ_9=CTQ_9_1,
         CTQ_10=CTQ_10_1,
         CTQ_11=CTQ_11_1,
         CTQ_12=CTQ_12_1,
         CTQ_13=ifelse(CTQ_13_1==1,5,
                       ifelse(CTQ_13_1==2,4,
                              ifelse(CTQ_13_1==3,3,
                                     ifelse(CTQ_13_1==4,2,
                                            ifelse(CTQ_13_1==5,1,
                                                   NA))))),
         CTQ_14=CTQ_14_1,
         CTQ_15=CTQ_15_1,
         CTQ_16=CTQ_16_1,
         CTQ_17=CTQ_17_1,
         CTQ_18=CTQ_18_1,
         CTQ_19=ifelse(CTQ_19_1==1,5,
                       ifelse(CTQ_19_1==2,4,
                              ifelse(CTQ_19_1==3,3,
                                     ifelse(CTQ_19_1==4,2,
                                            ifelse(CTQ_19_1==5,1,
                                                   NA))))),
         CTQ_20=CTQ_20_1,
         CTQ_21=CTQ_21_1,
         CTQ_22=CTQ_22_1,
         CTQ_23=CTQ_23_1,
         CTQ_24=CTQ_24_1,
         CTQ_25=CTQ_25_1,
         CTQ_26=ifelse(CTQ_26_1==1,5,
                       ifelse(CTQ_26_1==2,4,
                              ifelse(CTQ_26_1==3,3,
                                     ifelse(CTQ_26_1==4,2,
                                            ifelse(CTQ_26_1==5,1,
                                                   NA))))),
         CTQ_27=CTQ_27_1,
         CTQ_28=CTQ_28_1,
         CTQ_29=CTQ_29_1,
         CTQ_30=CTQ_30_1,
         CTQ_31=CTQ_31_1,
         CTQ_32=CTQ_32_1,
         CTQ_N=32) %>%
  mutate(CTQ_missing=rowSums(is.na(cbind(CTQ_1,CTQ_2,CTQ_3,CTQ_4,CTQ_5,CTQ_6,CTQ_7,CTQ_8,CTQ_9,CTQ_10,CTQ_11,CTQ_12,CTQ_13,CTQ_14,CTQ_15,CTQ_16,CTQ_17,CTQ_18,CTQ_19,CTQ_20,CTQ_21,CTQ_22,CTQ_23,CTQ_24,CTQ_25,CTQ_26,CTQ_27,CTQ_28,CTQ_29,CTQ_30,CTQ_31,CTQ_32))),
         CTQ_emotionalabuse_total=rowSums(cbind(CTQ_3,CTQ_8,CTQ_14,CTQ_18,CTQ_25,CTQ_31),na.rm=T),
         CTQ_emotionalneglect_total=rowSums(cbind(CTQ_5,CTQ_7,CTQ_13,CTQ_19,CTQ_28,CTQ_30),na.rm=T),
         CTQ_physicalabuse_total=rowSums(cbind(CTQ_9,CTQ_11,CTQ_12,CTQ_15,CTQ_17,CTQ_29),na.rm=T),
         CTQ_physicalneglect_total=rowSums(cbind(CTQ_1,CTQ_2,CTQ_4,CTQ_6,CTQ_26),na.rm=T),
         CTQ_sexualabuse_total=rowSums(cbind(CTQ_20,CTQ_21,CTQ_23,CTQ_24,CTQ_27),na.rm=T),
         CTQ_validity_total=rowSums(cbind(CTQ_10,CTQ_16,CTQ_22),na.rm=T),
         CTQ_emotionalabuse_mean=rowMeans(cbind(CTQ_3,CTQ_8,CTQ_14,CTQ_18,CTQ_25,CTQ_31),na.rm=F),
         CTQ_emotionalneglect_mean=rowMeans(cbind(CTQ_5,CTQ_7,CTQ_13,CTQ_19,CTQ_28,CTQ_30),na.rm=F),
         CTQ_physicalabuse_mean=rowMeans(cbind(CTQ_9,CTQ_11,CTQ_12,CTQ_15,CTQ_17,CTQ_29),na.rm=F),
         CTQ_physicalneglect_mean=rowMeans(cbind(CTQ_1,CTQ_2,CTQ_4,CTQ_6,CTQ_26),na.rm=F),
         CTQ_sexualabuse_mean=rowMeans(cbind(CTQ_20,CTQ_21,CTQ_23,CTQ_24,CTQ_27),na.rm=F),
         CTQ_validity_mean=rowMeans(cbind(CTQ_10,CTQ_16,CTQ_22),na.rm=F))

## Save it
CTQ_Wave1_outdf <- CTQ_Wave1 %>% filter(!grepl("W2|W3|W4|W5|W6",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid)) 
CTQ_Wave1_TAG2_outdf <- CTQ_Wave1 %>% filter(!grepl("W2|W3|W4|W5|W6",survey_name)) %>% 
  filter(!grepl("TAG0|TAG1|TAG2",tagid))
write.csv(CTQ_Wave1_outdf, file = paste0(workdir,"Qualtrics_Output/Wave1/CTQ_Wave1.csv"))
write.csv(CTQ_Wave1_TAG2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave1/CTQ_Wave1_TAG2.csv"))

CTQ_Wave2_outdf <- CTQ_Wave1 %>% filter(grepl("W2",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid))
write.csv(CTQ_Wave2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave2/CTQ_Wave2.csv"))

CTQ_Wave2_TAG2_outdf <- CTQ_Wave1 %>% filter(grepl("W2",survey_name)) %>% 
  filter(!grepl("TAG0|TAG1|TAG2",tagid))
write.csv(CTQ_Wave2_TAG2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave2/CTQ_Wave2_TAG2.csv"))

CTQ_Wave3_outdf <- CTQ_Wave1 %>% filter(grepl("W3",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid)) 
write.csv(CTQ_Wave3_outdf, file = paste0(workdir,"Qualtrics_Output/Wave3/CTQ_Wave3.csv"))

#not yet...
CTQ_Wave3_TAG2_outdf <- CTQ_Wave1 %>% filter(grepl("W3",survey_name)) %>% 
  filter(!grepl("TAG0|TAG1|TAG2",tagid))
#write.csv(CTQ_Wave3_TAG2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave3/CTQ_Wave3_TAG2.csv"))

CTQ_Wave4_outdf <- CTQ_Wave1 %>% filter(grepl("W4",survey_name)) 
write.csv(CTQ_Wave4_outdf, file = paste0(workdir,"Qualtrics_Output/Wave4/CTQ_Wave4.csv"))

CTQ_Wave5_outdf <- CTQ_Wave1 %>% filter(grepl("W5",survey_name)) 
write.csv(CTQ_Wave5_outdf, file = paste0(workdir,"Qualtrics_Output/Wave5/CTQ_Wave5.csv"))

CTQ_Wave6_outdf <- CTQ_Wave1 %>% filter(grepl("W6",survey_name)) 
write.csv(CTQ_Wave6_outdf, file = paste0(workdir,"Qualtrics_Output/Wave6/CTQ_Wave6.csv"))
```
