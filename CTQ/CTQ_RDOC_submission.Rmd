```{r}
## Make RDOC ready file
ndar_ctq_data <- left_join(CTQ_Wave1,distinct(redcap_cleaned, tagid, dob),by="tagid") %>%
  filter(!is.na(survey_date),!survey_date=="") %>%
  mutate(interview_date=paste0(sprintf("%02d",month(survey_date)),"/",sprintf("%02d",day(survey_date)),"/",year(survey_date)),
         interview_age=round((interval(start =dob, end = survey_date) / duration(num = 1, units = "months")),0),
         sex="F",
         site="University of Oregon",
         study="TAG study",
         ctq_01=CTQ_1,
         ctq_02=CTQ_2,
         ctq_03=CTQ_3,
         ctq_04=CTQ_4,
         ctq_05=CTQ_5,
         ctq_06=CTQ_6,
         ctq_07=CTQ_7,
         ctq_08=CTQ_8,
         ctq_09=CTQ_9,
         ctq_10=CTQ_10,
         ctq_11=CTQ_11,
         ctq_12=CTQ_12,
         ctq_13=CTQ_13,
         ctq_14=CTQ_14,
         ctq_15=CTQ_15,
         ctq_16=CTQ_16,
         ctq_17=CTQ_17,
         ctq_18=CTQ_18,
         ctq_19=CTQ_19,
         ctq_20=CTQ_20,
         ctq_21=CTQ_21,
         ctq_22=CTQ_22,
         ctq_23=CTQ_23,
         ctq_24=CTQ_24,
         ctq_25=CTQ_25,
         ctq_26=CTQ_26,
         ctq_27=CTQ_27,
         ctq_28=CTQ_28,
         ctq_29=CTQ_29,
         ctq_30=CTQ_30,
         ctq_31=CTQ_31,
         ctq_32=CTQ_32,
         ctqscore_ea=CTQ_emotionalabuse_total,
         ctqscore_en=CTQ_emotionalneglect_total,
         ctqscore_pa=CTQ_physicalabuse_total,
         ctqscore_pn=CTQ_physicalneglect_total,
         ctqscore_sa=CTQ_sexualabuse_total,
         ctqscore_val=CTQ_validity_total)
ndar_ctq_data <- left_join(ndar_key,ndar_ctq_data, by="tagid") %>%
  mutate(src_subject_id=anontagid,
         subjectkey=guid) %>%
  filter(!is.na(subjectkey),
         !interview_age=="") %>%
  select(-contains("CTQ",ignore.case = FALSE),-dob,-survey_date,-survey_name,-tagid,-anontagid,-ID,-guid,-survey_type)
ctq_df_header<-rep(NA,length(read.csv(paste0(workdir,"RDoCdb/templates/ctq01_template.csv"), header = FALSE, stringsAsFactors = FALSE)))
ctq_df_header[1]<-read.csv(paste0(workdir,"RDoCdb/templates/ctq01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,1]
ctq_df_header[2]<-read.csv(paste0(workdir,"RDoCdb/templates/ctq01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,2]

ctq_temp<-as.list(read.csv(paste0(workdir,"RDoCdb/templates/ctq01_template.csv"), header = TRUE, stringsAsFactors = FALSE, skip=1))
ctq_temp_df<-data.frame(ctq_temp)
ndar_ctq_data<-rbind(ctq_temp_df,ndar_ctq_data)

part2<-colnames(ndar_ctq_data)
part3<-as.matrix(ndar_ctq_data)
colnames(part3)<-NULL
together<-rbind(ctq_df_header,part2,part3)
write.table(together,file =paste0(workdir,"RDoCdb/output/jul2025/ctq01.csv"),sep=",",na = "",row.names=FALSE,col.names=FALSE)
rm(together,part2,part3,ctq_df_header,ctq_temp,ctq_temp_df,CTQ,CTQ_Wave1,CTQ_Wave1_means,CTQ_Wave1_means_graph,CTQ_Wave1_totals,CTQ_Wave1_totals_graph)
```
