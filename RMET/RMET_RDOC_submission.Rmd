```{r}
## Make RDOC ready file
ndar_rmet_data <- left_join(RMET_Wave1,distinct(redcap_cleaned, tagid, dob),by="tagid") %>%
  filter(!is.na(survey_date),!survey_date=="") %>%
  mutate(interview_date=paste0(sprintf("%02d",month(survey_date)),"/",sprintf("%02d",day(survey_date)),"/",year(survey_date)),
         interview_age=round((interval(start =dob, end = survey_date) / duration(num = 1, units = "months")),0),
         sex="F",
         visit=ifelse(grepl("Sess 1",survey_name),"Session1",
                      ifelse(grepl("Session 1",survey_name),"Session1",
                             ifelse(grepl("Sess 2",survey_name),"Session2",
                                    ifelse(grepl("Session 2",survey_name),"Session2",
                                           ifelse(grepl("Home",survey_name),"Home Questionnaires",
                                                  NA))))),
         version_form="Child Version",
         site="University of Oregon",
         #gender="F",
         rmet_cv001=RMET_1,
         rmet_cv002=RMET_2,
         rmet_cv003=RMET_3,
         rmet_cv004=RMET_4,
         rmet_cv005=RMET_5,
         rmet_cv006=RMET_6,
         rmet_cv007=RMET_7,
         rmet_cv008=RMET_8,
         rmet_cv009=RMET_9,
         rmet_cv010=RMET_10,
         rmet_cv011=RMET_11,
         rmet_cv012=RMET_12,
         rmet_cv013=RMET_13,
         rmet_cv014=RMET_14,
         rmet_cv015=RMET_15,
         rmet_cv016=RMET_16,
         rmet_cv017=RMET_17,
         rmet_cv018=RMET_18,
         rmet_cv019=RMET_19,
         rmet_cv020=RMET_20,
         rmet_cv021=RMET_21,
         rmet_cv022=RMET_22,
         rmet_cv023=RMET_23,
         rmet_cv024=RMET_24,
         rmet_cv025=RMET_25,
         rmet_cv026=RMET_26,
         rmet_cv027=RMET_27,
         rmet_cv028=RMET_28,
         form_completed=ifelse(RMET_1_numcompleted==28,1,2),
         form_explain=ifelse(!RMET_1_numcompleted==28,87,86),
         assessment_complete=ifelse(RMET_1_numcompleted==28,2,0),
         child_eyestotal=ifelse(!is.na(RMET_Total_Score),RMET_Total_Score,"")
  )

ndar_rmet_data <- left_join(ndar_key,ndar_rmet_data, by="tagid") %>%
  mutate(src_subject_id=anontagid,
         subjectkey=guid) %>%
  filter(!is.na(subjectkey),
         !interview_age=="") %>%
  select(-contains("RMET",ignore.case = FALSE),-dob,-survey_date,-survey_name,-tagid,-anontagid,-ID,-guid,-survey_type)
rmet_df_header<-rep(NA,length(read.csv(paste0(workdir,"RDoCdb/templates/rmet_cv01_template.csv"), header = FALSE, stringsAsFactors = FALSE)))
rmet_df_header[1]<-read.csv(paste0(workdir,"RDoCdb/templates/rmet_cv01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,1]
rmet_df_header[2]<-read.csv(paste0(workdir,"RDoCdb/templates/rmet_cv01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,2]

rmet_temp<-as.list(read.csv(paste0(workdir,"RDoCdb/templates/rmet_cv01_template.csv"), header = TRUE, stringsAsFactors = FALSE, skip=1))
rmet_temp_df<-data.frame(rmet_temp)
ndar_rmet_data<-rbind(rmet_temp_df,ndar_rmet_data)

part2<-colnames(ndar_rmet_data)
part3<-as.matrix(ndar_rmet_data)
colnames(part3)<-NULL
together<-rbind(rmet_df_header,part2,part3)
write.table(together,file =paste0(workdir,"RDoCdb/output/jul2025/rmet_cv01.csv"),sep=",",na = "",row.names=FALSE,col.names=FALSE)
rm(together,part2,part3,rmet_df_header,rmet_temp,rmet_temp_df,RMET,RMET_Wave1,RMET_Wave1_percentcorrect,RMET_Wave1_percentcorrect_graph)
```
