---
title: "Score_Qualtrics"
author: "dsnlab"
date: "20-Nov-2025"
output: html_document
---

ONLY RUN IF Prepping for NDA Submission: Prepare GUIDs
```{r, eval=FALSE, include=FALSE}
redcap_NDA_info <- read.csv(paste0(workdir,"RDoCdb/Confidential/redcap_nda_consent_20250617.csv"),
                            header = TRUE,
                            stringsAsFactors = FALSE)

redcapNDA_sessiondates<-redcap_NDA_info %>%
  select(sa_date,sb_date,subject_spit_id) %>%
  filter(!sa_date=="" & !sb_date=="") %>%
  distinct()

redcap_NDA_info$nda_form_date <- as.Date(redcap_NDA_info$nda_form_date, format = "%m/%d/%y")
redcap_NDA_info$dob <- as.Date(redcap_NDA_info$dob, format = "%m/%d/%y")
redcap_NDA_info$sa_date <- as.Date(redcap_NDA_info$sa_date, format = "%m/%d/%y")
redcap_NDA_info$sb_date <- as.Date(redcap_NDA_info$sb_date, format = "%m/%d/%y")

redcapNDA_data<-redcap_NDA_info %>%
  select(-sa_date,-sb_date) %>%
  filter(!participant_first_name=="") %>%
  distinct()

redcapNDA_sessiondates$sa_date <- as.Date(redcapNDA_sessiondates$sa_date, format = "%m/%d/%y")
redcapNDA_sessiondates$sb_date <- as.Date(redcapNDA_sessiondates$sb_date, format = "%m/%d/%y")

redcap_NDA_info<-merge(redcapNDA_sessiondates,redcapNDA_data) %>%
  mutate(tagid=substring(subject_spit_id,first=4,last=length(subject_spit_id)))%>%
  filter(!subject_spit_id=="TAG_001P") %>%
  mutate(tagid=ifelse(nchar(tagid)==4,substring(subject_spit_id,first=5,last=length(subject_spit_id)),tagid),
         dob=as.Date(dob),
         sa_date=as.Date(sa_date),
         sb_date=as.Date(sb_date))

#rm(redcapNDA_data,redcapNDA_sessiondates)

guid_colnames<-colnames(read.csv(paste0(workdir,"RDoCdb/templates/guid_sample_template.csv"),
                                 header = TRUE,
                                 stringsAsFactors = FALSE,
                                 nrow=1))

consentedlist<-unique(redcap_NDA_info %>%
                  filter((nda_consent___1==1 & nda_consent___2==1) | 
                           (nda_consent_2___1==1 & nda_consent_2___2==1) | 
                           (nda_consent_3___1==1 & nda_consent_3___2==1) | 
                           (nda_consent4___1==1 & nda_consent4___2==1) | 
                           (nda_consent_tag2w1___1==1 & nda_consent_tag2w1___2==1)) %>%
                  select(tagid))[[1]]

prepareGUIDs=function(subID){
  sub_NDA_info<-redcap_NDA_info %>% filter(tagid==subID)
  assign(guid_colnames[2], sub_NDA_info$participant_first_name)
  assign(guid_colnames[3], ifelse(sub_NDA_info$participant_middle_name=="No Middle Name",
                                  "",
                                  sub_NDA_info$participant_middle_name))
  assign(guid_colnames[4], sub_NDA_info$participant_last_name)
  assign(guid_colnames[5], month(parse_date_time(sub_NDA_info$dob[1], order=c('ymd'))))
  assign(guid_colnames[6], day(parse_date_time(sub_NDA_info$dob[1], order=c('ymd'))))
  assign(guid_colnames[7], year(parse_date_time(sub_NDA_info$dob[1], order=c('ymd'))))
  assign(guid_colnames[8], sub_NDA_info$participant_city_of_birth)
  assign(guid_colnames[9],"F")
  assign(guid_colnames[10],ifelse(sub_NDA_info$participant_middle_name=="No Middle Name","NO","YES"))
  assign(guid_colnames[11],"YES")
  cbind(subID,get(guid_colnames[2]),get(guid_colnames[3]),get(guid_colnames[4]),get(guid_colnames[5]),get(guid_colnames[6]),
        get(guid_colnames[7]),get(guid_colnames[8]),get(guid_colnames[9]),get(guid_colnames[10]),get(guid_colnames[11]))
}

guid_batch<-lapply(consentedlist,prepareGUIDs)
guid_batch.df<-as.data.frame(do.call(rbind,guid_batch)) %>% distinct()
guid_batch_ids<-guid_batch.df %>%
  select(subID) %>%
  mutate(ID=row.names(guid_batch.df),
         tagid=sprintf("TAG%03s",subID)) %>%
  select(-subID)
guid_batch.df<- guid_batch.df %>% select(-subID)
guid_batch.df<-cbind(guid_colnames[1],guid_batch.df)
colnames(guid_batch.df) <- guid_colnames
guid_batch.df$ID <-row.names(guid_batch.df)
print(paste0("GUID batch created for ",nrow(guid_batch.df)," participants!"))
rm(guid_batch,guid_colnames,consentedlist,redcap_NDA_info)
write.csv(guid_batch.df,file=paste0(workdir,"RDoCdb/Confidential/GUID_batch_",Sys.Date(),".csv"),row.names = FALSE)
write.csv(guid_batch_ids,file=paste0(workdir,"RDoCdb/Confidential/GUID_batch_subIDkey_",Sys.Date(),".csv"),row.names = FALSE)
```
