```{r}
## Make RDOC ready file
ndar_ksrq_data <- left_join(KSRQ_Wave1,distinct(redcap_cleaned, tagid, dob),by="tagid") %>%
  filter(!is.na(survey_date)) %>%
  mutate(interview_date=paste0(sprintf("%02d",month(survey_date)),"/",sprintf("%02d",day(survey_date)),"/",year(survey_date)),
         interview_age=round((interval(start =dob, end = survey_date) / duration(num = 1, units = "months")),0),
         sex="F",
         comments_misc=ifelse(grepl("Sess 1",survey_name),"Session1",
                             ifelse(grepl("Sess 2",survey_name),"Session2",
                                           ifelse(grepl("Home",survey_name),"Home Questionnaires",NA))),
         version_form="Child version",
         site="University of Oregon",
         study="Transitions in Adolescent Girls (TAG) Study",
         ksrq_1=K_SRQ_1,
         ksrq_2=K_SRQ_2,
         ksrq_3=K_SRQ_3,
         ksrq_4=K_SRQ_4,
         ksrq_5=K_SRQ_5,
         ksrq_6=K_SRQ_6,
         ksrq_7=K_SRQ_7,
         ksrq_8=K_SRQ_8,
         ksrq_9=K_SRQ_9,
         ksrq_10=K_SRQ_10,
         ksrq_11=K_SRQ_11,
         ksrq_12=K_SRQ_12,
         ksrq_13=ifelse(is.na(K_SRQ_23),-99,K_SRQ_23),
         ksrq_14=K_SRQ_13,
         ksrq_15=K_SRQ_14,
         ksrq_16=K_SRQ_15,
         ksrq_17=K_SRQ_16,
         ksrq_18=K_SRQ_17,
         ksrq_19=K_SRQ_18,
         ksrq_20=K_SRQ_19,
         ksrq_21=K_SRQ_20,
         ksrq_22=K_SRQ_21,
         ksrq_23=K_SRQ_22,
         ksrq_adm=KSRQ_adm_mean,
         krsq_negsoc=KSRQ_negsoc_mean,
         krsq_pass=KSRQ_pass_mean,
         krsq_prosoc=KSRQ_prosoc_mean,
         krsq_sex=KSRQ_sex_mean,
         krsq_social=KSRQ_social_mean)
ndar_ksrq_data <- left_join(ndar_key,ndar_ksrq_data, by="tagid") %>%
  mutate(src_subject_id=anontagid,
         subjectkey=guid) %>%
  filter(!is.na(subjectkey),
         !interview_age=="") %>%
  select(-contains("SRQ",ignore.case = FALSE),-dob,-survey_date,-survey_name,-tagid,-anontagid,-ID,-guid,-survey_type)
ksrq_df_header<-rep(NA,length(read.csv(paste0(workdir,"RDoCdb/templates/srq01_template.csv"), header = FALSE, stringsAsFactors = FALSE)))
ksrq_df_header[1]<-read.csv(paste0(workdir,"RDoCdb/templates/srq01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,1]
ksrq_df_header[2]<-read.csv(paste0(workdir,"RDoCdb/templates/srq01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,2]

ksrq_temp<-as.list(read.csv(paste0(workdir,"RDoCdb/templates/srq01_template.csv"), header = TRUE, stringsAsFactors = FALSE, skip=1))
ksrq_temp_df<-data.frame(ksrq_temp)
ndar_ksrq_data<-rbind(ksrq_temp_df,ndar_ksrq_data)

part2<-colnames(ndar_ksrq_data)
part3<-as.matrix(ndar_ksrq_data)
colnames(part3)<-NULL
together<-rbind(ksrq_df_header,part2,part3)
write.table(together,file =paste0(workdir,"RDoCdb/output/jul2025/srq01.csv"),sep=",",na = "",row.names=FALSE,col.names=FALSE)
rm(together,part2,part3,ksrq_df_header,ksrq_temp,ksrq_temp_df,KSRQ,KSRQ_Wave1,KSRQ_Wave1_means,KSRQ_Wave1_means_graph)
```
