```{r}
## Make RDOC ready file
ndar_mspss_data <- left_join(MSPSS_Wave1,distinct(redcap_cleaned, tagid, dob),by="tagid") %>%
  filter(!is.na(survey_date),!survey_date=="") %>%
  mutate(interview_date=paste0(sprintf("%02d",month(survey_date)),"/",sprintf("%02d",day(survey_date)),"/",year(survey_date)),
         interview_age=round((interval(start =dob, end = survey_date) / duration(num = 1, units = "months")),0),
         sex="F",
         timept=1,
         mspss_1=MSPSS_1,
         mspss_2=MSPSS_2,
         mspss_3=MSPSS_3,
         mspss_4=MSPSS_4,
         mspss_5=MSPSS_5,
         mspss_6=MSPSS_6,
         mspss_7=MSPSS_7,
         mspss_8=MSPSS_8,
         mspss_9=MSPSS_9,
         mspss_10=MSPSS_10,
         mspss_11=MSPSS_11,
         mspss_12=MSPSS_12,
         mspss_fam=ifelse(is.na(MSPSS_fam_total),999,MSPSS_fam_total),
         mspss_fri=ifelse(is.na(MSPSS_fri_total),999,MSPSS_fri_total),
         mspss_so=ifelse(is.na(MSPSS_so_total),999,MSPSS_so_total),
         mspss_total=ifelse(is.na(MSPSS_total),999,MSPSS_total))
ndar_mspss_data <- left_join(ndar_key,ndar_mspss_data, by="tagid") %>%
  mutate(src_subject_id=anontagid,
         subjectkey=guid) %>%
  filter(!is.na(subjectkey),
         !interview_age=="") %>%
  select(-contains("MSPSS",ignore.case = FALSE),-dob,-survey_date,-survey_name,-tagid,-anontagid,-ID,-guid,-survey_type)
mspss_df_header<-rep(NA,length(read.csv(paste0(workdir,"RDoCdb/templates/mspss01_template.csv"), header = FALSE, stringsAsFactors = FALSE)))
mspss_df_header[1]<-read.csv(paste0(workdir,"RDoCdb/templates/mspss01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,1]
mspss_df_header[2]<-read.csv(paste0(workdir,"RDoCdb/templates/mspss01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,2]

mspss_temp<-as.list(read.csv(paste0(workdir,"RDoCdb/templates/mspss01_template.csv"), header = TRUE, stringsAsFactors = FALSE, skip=1))
mspss_temp_df<-data.frame(mspss_temp)
ndar_mspss_data<-rbind(mspss_temp_df,ndar_mspss_data)

part2<-colnames(ndar_mspss_data)
part3<-as.matrix(ndar_mspss_data)
colnames(part3)<-NULL
together<-rbind(mspss_df_header,part2,part3)
write.table(together,file =paste0(workdir,"RDoCdb/output/jul2025/mspss01.csv"),sep=",",na = "",row.names=FALSE,col.names=FALSE)
rm(together,part2,part3,mspss_df_header,mspss_temp,mspss_temp_df,MSPSS,MSPSS_Wave1,MSPSS_Wave1_means,MSPSS_Wave1_means_graph,
   MSPSS_Wave1_totals,MSPSS_Wave1_totals_graph)
```
