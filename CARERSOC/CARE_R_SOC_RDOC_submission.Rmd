```{r}
## Make RDOC ready file
ndar_carersoc_data <- left_join(CARE_R_SOC_Wave1,distinct(redcap_cleaned, tagid, dob),by="tagid") %>%
  filter(!is.na(survey_date),!survey_date=="") %>%
  mutate(interview_date=paste0(sprintf("%02d",month(survey_date)),"/",sprintf("%02d",day(survey_date)),"/",year(survey_date)),
         interview_age=round((interval(start =dob, end = survey_date) / duration(num = 1, units = "months")),0),
         version_form="CARE-R Social Outcome Appraisal Questions",
         comments_misc=ifelse(grepl("Sess 1",survey_name),"Session1",
                              ifelse(grepl("Session 1",survey_name),"Session1",
                                     ifelse(grepl("Sess 2",survey_name),"Session2",
                                            ifelse(grepl("Session 2",survey_name),"Session2",
                                                   ifelse(grepl("Home",survey_name),"Home Questionnaires",NA))))),
         sex="F",
         carersoc_1=`CARE-R_I`,
         carersoc_2=`CARE-R_II`,
         carersoc_3=`CARE-R_1A`,
         carersoc_4=`CARE-R_1B`,
         carersoc_5=`CARE-R_2A`,
         carersoc_6=`CARE-R_2B`,
         carersoc_7=`CARE-R_3A`,
         carersoc_8=`CARE-R_3B`,
         carersoc_9=`CARE-R_4A`,
         carersoc_10=`CARE-R_4B`,
         carersoc_11=`CARE-R_5A`,
         carersoc_12=`CARE-R_5B`,
         carersoc_13=`CARE-R_6A`,
         carersoc_14=`CARE-R_6B`,
         carersoc_15=`CARE-R_7A`,
         carersoc_16=`CARE-R_7B`,
         carersoc_17=`CARE-R_8A`,
         carersoc_18=`CARE-R_8B`,
         carersoc_19=`CARE-R_9A`,
         carersoc_20=`CARE-R_9B`,
         carersoc_21=`CARE-R_10A`,
         carersoc_22=`CARE-R_10B`,
         carersoc_23=`CARE-R_11A`,
         carersoc_24=`CARE-R_11B`,
         carersoc_25=`CARE-R_12A`,
         carersoc_26=`CARE-R_12B`,
         carersoc_27=`CARE-R_13A`,
         carersoc_28=`CARE-R_13B`,
         carersoc_29=`CARE-R_14A`,
         carersoc_30=`CARE-R_14B`
  )
ndar_carersoc_data <- left_join(ndar_key,ndar_carersoc_data, by="tagid") %>%
  mutate(src_subject_id=anontagid,
         subjectkey=guid) %>%
  filter(!is.na(subjectkey),
         !interview_age=="") %>%
  select(-contains("CARE-R",ignore.case = FALSE),-dob,-survey_date,-survey_type,-survey_name,-tagid,-anontagid,-ID,-guid,
         -contains("substance"),-carersoc_gen,-contains("violence"),-contains("graffiti"),-contains("reckless"), 
         -carersoc_gen_N,-carersoc_gen_missing, -carersoc_gen_missing_perc)
carersoc_df_header<-rep(NA,length(read.csv(paste0(workdir,"RDoCdb/templates/caore01_template.csv"), header = FALSE, stringsAsFactors = FALSE)))
carersoc_df_header[1]<-read.csv(paste0(workdir,"RDoCdb/templates/caore01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,1]
carersoc_df_header[2]<-read.csv(paste0(workdir,"RDoCdb/templates/caore01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,2]

carersoc_temp<-as.list(read.csv(paste0(workdir,"RDoCdb/templates/caore01_template.csv"), header = TRUE, stringsAsFactors = FALSE, skip=1))
carersoc_temp_df<-data.frame(carersoc_temp)
ndar_carersoc_data<-rbind(carersoc_temp_df,ndar_carersoc_data)

part2<-colnames(ndar_carersoc_data)
part3<-as.matrix(ndar_carersoc_data)
colnames(part3)<-NULL
together<-rbind(carersoc_df_header,part2,part3)
write.table(together,file =paste0(workdir,"RDoCdb/output/jul2025/caore01.csv"),sep=",",na = "",row.names=FALSE,col.names=FALSE)
rm(together,part2,part3,carersoc_df_header,carersoc_temp,carersoc_temp_df,CARE_R_SOC,CARE_R_SOC_Wave1,CARE_R_SOC_Wave1_DO,
   CARE_R_SOC_Wave1_DO_graph,CARE_R_SOC_Wave1_DONT_graph,CARE_R_SOC_Wave1_DONT)
```
