Prepare PDS #note: this is self-report
```{r}
PDS<-left_join(filter(cleaned_survey_data, grepl("PDS",item)) %>% 
                 mutate(value=as.numeric(value)) %>% 
                 #filter(!grepl("Parent",survey_name)) %>%
                 filter(!is.na(value)) %>% 
                 distinct(tagid,item,value,survey_name,.keep_all = FALSE) %>% 
                 spread(item,value),
               redcap_cleaned %>%
                 filter(!is.na(dob),!is.na(sa_date)) %>%
                 dplyr::select(tagid, sa_date, sb_date, sos_session_date, dob),by="tagid")

#NV: Load in info about menstruation to update missing PDS_F6
Menstruation <- read.csv(paste0(workdir,'Puberty/Puberty_fromQuestionnaires/Puberty_Followup/Menstruation.csv'), header=T)

Menstruation <- Menstruation %>%
  dplyr::select(tagid,menstruation_by_Wave1SB.before.wave.1) %>%
  mutate(w1_Menarche = ifelse(menstruation_by_Wave1SB.before.wave.1=="yes",1,0))
w1_Menarche = as.list(Menstruation %>% filter(w1_Menarche==1) %>% dplyr::select(tagid) %>% arrange(tagid))
w1_NoMenarche = as.list(Menstruation %>% filter(w1_Menarche==0) %>% dplyr::select(tagid) %>% arrange(tagid))

#NV: Update missing PDS_F6 in PDS dataframe with info on menstruation collected by other methods 
PDS <- PDS %>%
  mutate(PDS_F6 = ifelse((!grepl("W2|W3|W4|W5|W6|ACE|SOS",survey_name) & is.na(PDS_F6) & (tagid %in% w1_Menarche$tagid)), 1, 
                         ifelse((!grepl("W2|W3|W4|W5|W6|ACE|SOS",survey_name) & is.na(PDS_F6) & (tagid %in% w1_NoMenarche$tagid)), 0,
                                PDS_F6)))
                         
PDS_Wave1<-left_join(PDS,survey_date, by = c("tagid","survey_name")) %>% 
  distinct(tagid,survey_name,.keep_all = TRUE) %>%
  mutate(qualtrics_date=value) %>% 
  dplyr::select(-value) %>%
  #mutate(survey_date=ifelse(survey_name=="TAG - Sess 2 - V1",sb_date,
   #                         ifelse(survey_name=="TAG - Sess 2 - V2",sb_date,
    #                               ifelse(survey_name=="TAG - Sess 2 - V3 - Current",sb_date,
     #                                     ifelse(survey_name=="Sensitive Q's for 042",sb_date,as.character(qualtrics_date)
      #                                    ))))) %>%
  mutate(survey_date=qualtrics_date) %>% 
  dplyr::select(-qualtrics_date,-sb_date,-sa_date,-sos_session_date,-dob) %>%
  mutate(peta=PDS_F1,
         petb=PDS_F2,
         petc=PDS_F3,
         petd=PDS_F4,
         pete=PDS_F5,
         fpete=PDS_F6,
         petaf=ifelse(PDS_F1==1,1,
                      ifelse(PDS_F1==2,2,
                             ifelse(PDS_F1==3,3,
                                    ifelse(PDS_F1==4,5,
                                           NA)))),
         petbf=ifelse(PDS_F2==1,1,
                      ifelse(PDS_F2==2,2,
                             ifelse(PDS_F2==3,4,
                                    ifelse(PDS_F2==4,5,
                                           NA)))),
         petcf=ifelse(PDS_F3==1,1,
                      ifelse(PDS_F3==2,2,
                             ifelse(PDS_F3==3,4,
                                    ifelse(PDS_F3==4,5,
                                           NA)))),
         petdf=ifelse(PDS_F4==1,1,
                      ifelse(PDS_F4==2,3,
                             ifelse(PDS_F4==3,4,
                                    ifelse(PDS_F4==4,5,
                                           NA)))),         
         petef=ifelse(PDS_F6==0,1,
                      ifelse(PDS_F6==1,5,
                             NA))) %>%
  mutate(adrenf=rowMeans(cbind(petbf,petcf),na.rm=F)) %>%
  mutate(adrenf2=ifelse(adrenf==1,1,
                        ifelse(petb==1 & adrenf==1.5,1,
                               ifelse(petb==2 & adrenf==1.5,2,
                                      ifelse(adrenf==2,2,
                                             ifelse(adrenf==2.5,3,
                                                    ifelse(adrenf==3,3,
                                                           ifelse(adrenf==3.5,4,
                                                                  ifelse(adrenf==4,4,
                                                                         ifelse(adrenf==4.5,5,
                                                                                ifelse(adrenf==5,5,
                                                                                       NA))))))))))) %>%
  mutate(gonadf=rowMeans(cbind(petaf,petdf),na.rm=F)) %>%
  mutate(gonadf2=ifelse(gonadf==1 & petef==1,1,
                        ifelse(gonadf==1.5 & petef==1,1,
                               ifelse(gonadf==2 & petef==1,2,
                                      ifelse(gonadf==2.5 & petef==1,2,
                                             ifelse(gonadf==3 & petef==1,3,
                                                    ifelse(gonadf==3.5 & petef==1,3,
                                                           ifelse(gonadf==4 & petef==1,3,
                                                                  ifelse(gonadf==4.5 & petef==1,4,
                                                                         ifelse(gonadf==5 & petef==1,4,
                                                                                ifelse(gonadf==1 & petef==5,2,
                                                                                       ifelse(gonadf==1.5 & petef==5,3,
                                                                                              ifelse(gonadf==2 & petef==5,4,
                                                                                                     ifelse(gonadf==2.5 & petef==5,4,
                                                                                                            ifelse(gonadf==3 & petef==5,4,
                                                                                                                   ifelse(gonadf==3.5 & petef==5,5,
                                                                                                                          ifelse(gonadf==4 & petef==5,5,
                                                                                                                                 ifelse(gonadf==4.5 & petef==5,5,
                                                                                                                                        ifelse(gonadf==5 & petef==5,5,
                                                                                                                                               NA))))))))))))))))))) %>%
  mutate(pdss=rowMeans(cbind(adrenf2,gonadf2),na.rm=F),
         pdss_N=5,
         pdss_missing=rowSums(is.na(cbind(PDS_F1,PDS_F2,PDS_F3,PDS_F4,PDS_F6))),
         pdss_missing_perc=100*(rowSums(is.na(cbind(PDS_F1,PDS_F2,PDS_F3,PDS_F4,PDS_F6)))/5),
         adrenf2_N=2,
         adrenf2_missing=rowSums(is.na(cbind(PDS_F2,PDS_F3))),
         adrenf2_missing_perc=100*(rowSums(is.na(cbind(PDS_F2,PDS_F3)))/2),
         gonadf2_N=3,
         gonadf2_missing=rowSums(is.na(cbind(PDS_F1,PDS_F4,PDS_F6))),
         gonadf2_missing_perc=100*(rowSums(is.na(cbind(PDS_F1,PDS_F4,PDS_F6)))/3),
         ) #NV added perc missing

#renaming new vars
PDS_cleaned <- PDS_Wave1 %>% mutate(PDS_F7 = 
    ifelse(PDS_F7==1,"47 or less",
           ifelse(PDS_F7==2,"48", 
                  ifelse(PDS_F7==3,"49",
                         ifelse(PDS_F7==4,"50",
                                ifelse(PDS_F7==5,"51",
                                       ifelse(PDS_F7==6,"52", 
                                              ifelse(PDS_F7==7,"53", 
                                                     ifelse(PDS_F7==8,"54", 
    ifelse(PDS_F7==9,"55", 
           ifelse(PDS_F7==10,"56", 
                  ifelse(PDS_F7==11,"57", 
                         ifelse(PDS_F7==12,"58", 
                                ifelse(PDS_F7==13,"59", 
                                       ifelse(PDS_F7==14,"60", 
                                              ifelse(PDS_F7==15,"61", 
    ifelse(PDS_F7==16,"62", 
           ifelse(PDS_F7==17,"63", 
                  ifelse(PDS_F7==18,"64", 
                         ifelse(PDS_F7==19,"65", 
                                ifelse(PDS_F7==20,"66",
                                       ifelse(PDS_F7==21,"67", 
                                              ifelse(PDS_F7==22,"68", 
    ifelse(PDS_F7==23,"69", 
           ifelse(PDS_F7==24,"70", 
                  ifelse(PDS_F7==25,"71", 
                         ifelse(is.na(PDS_F7),NA,PDS_F7)))))))))
)))))))))))))))))) %>% 
  rename(height_inches = PDS_F7) %>% 
  mutate(PDS_F8 = 
    ifelse(PDS_F8==1,"less than 40",
           ifelse(PDS_F8==2,"40-50", 
                  ifelse(PDS_F8==3,"50-60",
                         ifelse(PDS_F8==4,"60-70",
                                ifelse(PDS_F8==5,"70-80",
                                       ifelse(PDS_F8==6,"80-90", 
                                              ifelse(PDS_F8==7,"90-100", 
                                                     ifelse(PDS_F8==8,"100-110", 
    ifelse(PDS_F8==9,"110-120", 
           ifelse(PDS_F8==10,"120-130", 
                  ifelse(PDS_F8==11,"130-140", 
                         ifelse(PDS_F8==12,"140-150", 
                                ifelse(PDS_F8==13,"150-160", 
                                       ifelse(PDS_F8==14,"160-170", 
                                              ifelse(PDS_F8==15,"170-180", 
    ifelse(PDS_F8==16,"180-190", 
           ifelse(PDS_F8==17,"190-200", 
                  ifelse(PDS_F8==18,"200-210", 
                         ifelse(PDS_F8==19,"210-220", 
                                ifelse(PDS_F8==20,"220-230",
                                       ifelse(PDS_F8==21,"230-240", 
                                              ifelse(PDS_F8==22,"240-250", 
    ifelse(PDS_F8==23,"250-260", 
           ifelse(PDS_F8==24,"260-270", 
                  ifelse(PDS_F8==25,"270-280",
                         ifelse(PDS_F8==26,"280-290", 
                                ifelse(PDS_F8==27,"290-300", 
                                       ifelse(PDS_F8==28,"more than 300",NA))))))))
))))))))))))))))))))) %>% 
  rename(weight_pounds = PDS_F8)%>% 
  mutate(PDS_F9_4_3 = ifelse(!is.na(PDS_F9_4_3),PDS_F9_4_3,PDS_F9)) %>% 
  mutate(PDS_F9_4_3 = ifelse((PDS_F9_4_3==1 & survey_name=="W3S2 - V4"),2015,
  ifelse((PDS_F9_4_3==2 & survey_name=="W3S2 - V4"),2016, 
         ifelse((PDS_F9_4_3==3 & survey_name=="W3S2 - V4"),2017, 
                ifelse((PDS_F9_4_3==4 & survey_name=="W3S2 - V4"),2018, 
  ifelse((PDS_F9_4_3==5 & survey_name=="W3S2 - V4"),2019, 
         ifelse((PDS_F9_4_3==1 & survey_name=="W3S2 - V5"),2015,
  ifelse((PDS_F9_4_3==2 & survey_name=="W3S2 - V5"),2016, 
         ifelse((PDS_F9_4_3==3 & survey_name=="W3S2 - V5"),2017, 
                ifelse((PDS_F9_4_3==4 & survey_name=="W3S2 - V5"),2018, 
  ifelse((PDS_F9_4_3==5 & survey_name=="W3S2 - V5"),2019, 
         ifelse((PDS_F9_4_3==1 & survey_name=="W3S2 - V6"),2015,
  ifelse((PDS_F9_4_3==2 & survey_name=="W3S2 - V6"),2016, 
         ifelse((PDS_F9_4_3==3 & survey_name=="W3S2 - V6"),2017, 
                ifelse((PDS_F9_4_3==4 & survey_name=="W3S2 - V6"),2018, 
  ifelse((PDS_F9_4_3==5 & survey_name=="W3S2 - V6"),2019, PDS_F9_4_3)))))))))))))))) %>% 
  mutate(PDS_F9_4_3 = ifelse(PDS_F9_4_3==1,2014,
                             ifelse(PDS_F9_4_3==2,2015, 
                                    ifelse(PDS_F9_4_3==3,2016, 
                                           ifelse(PDS_F9_4_3==4,2017, 
  ifelse(PDS_F9_4_3==5,2018, 
         ifelse(PDS_F9_4_3==6,2019, 
                ifelse(PDS_F9_4_3==7,2020, 
                       ifelse(PDS_F9_4_3==8,2021,PDS_F9_4_3))))))))) %>% 
  rename(
       menarche_month = PDS_F9_4_1, 
       menarche_day = PDS_F9_4_2,  
       menarche_year = PDS_F9_4_3
      ) %>% dplyr::select(-PDS_F9) %>% 
  mutate(PDS_F10_1_4 = ifelse(PDS_F10_1_4==1,2015, 
                              ifelse(PDS_F10_1_4==2,2016, 
                                     ifelse(PDS_F10_1_4==3,2017, 
                                            ifelse(PDS_F10_1_4==4,2018, 
  ifelse(PDS_F10_1_4==5,2019,NA)))))) %>% 
  mutate(`PDS_F10#4_1` = ifelse(`PDS_F10#4_1`==1,2015, 
                                ifelse(`PDS_F10#4_1`==2,2016, 
                                       ifelse(`PDS_F10#4_1`==3,2017, 
                                              ifelse(`PDS_F10#4_1`==4,2018, 
  ifelse(`PDS_F10#4_1`==5,2019, 
         ifelse(`PDS_F10#4_1`==6,2020, 
                ifelse(`PDS_F10#4_1`==7,2021, 
                       ifelse(`PDS_F10#4_1`==8,2022,
                              ifelse(`PDS_F10#4_1`==9,2023,
                                     ifelse(`PDS_F10#4_1`==10,2024,
                                            ifelse(`PDS_F10#4_1`==11,"Not Applicable", NA)))))))))))) %>% 
  mutate(`PDS_F10#4_1` = ifelse(!is.na(`PDS_F10#3_1_1`),`PDS_F10#3_1_1`,`PDS_F10#4_1`)) %>% 
  dplyr::select(-`PDS_F10#3_1_1`) %>% 
    rename(
       lmp_month = `PDS_F10#1_1`, 
       lmp_day = `PDS_F10#2_1`,  
       lmp_year = `PDS_F10#4_1`
      ) %>% 
  mutate(lmp_month = ifelse(!is.na(PDS_F10_1_1),PDS_F10_1_1,lmp_month),
         lmp_day = ifelse(!is.na(PDS_F10_1_2),PDS_F10_1_2,lmp_day), 
         lmp_year = ifelse(!is.na(PDS_F10_1_4),PDS_F10_1_4,lmp_year)) %>% 
  dplyr::select(-c(PDS_F10_1_1,PDS_F10_1_2,PDS_F10_1_4))

PDS_cleaned_lmp_menarche <- PDS_cleaned %>% 
  filter_at(vars(PDS_F1,PDS_F2,PDS_F3,PDS_F4,PDS_F5), all_vars(is.na(.)))

PDS_cleaned_copy <- PDS_cleaned
#PDS_cleaned_copy <- PDS_cleaned
PDS_cleaned <- PDS_cleaned %>% 
  filter_at(vars(PDS_F1,PDS_F2,PDS_F3,PDS_F4,PDS_F5), any_vars(!is.na(.)))

## Save it
PDS_Wave1_outdf <- PDS_cleaned %>% filter(!grepl("W2|W3|W4|W5|W6|ACE|SOS|TAG2|Parent",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid))
PDS_Wave1_TAG2_outdf <- PDS_cleaned %>% filter(!grepl("W2|W3|W4|W5|W6|ACE|SOS|Parent",survey_name)) %>% 
  filter(!grepl("TAG0|TAG1|TAG2",tagid))
write.csv(PDS_Wave1_outdf, file = paste0(workdir,"Qualtrics_Output/Wave1/PDS_Wave1.csv"))
write.csv(PDS_Wave1_TAG2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave1/PDS_Wave1_TAG2.csv"))

PDS_Wave2_outdf <- PDS_cleaned %>% filter(grepl("W2",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid)) %>% filter(!grepl("Parent",survey_name))
PDS_Wave1add_p1_outdf <- PDS_Wave2_outdf[PDS_Wave2_outdf$survey_date=="2017-08-12",]
PDS_Wave1add_p2_outdf <- PDS_Wave2_outdf[PDS_Wave2_outdf$survey_date=="2017-12-12",]
PDS_Wave2_outdf <- PDS_Wave2_outdf[PDS_Wave2_outdf$survey_date!="2017-08-12",]
PDS_Wave2_outdf <- PDS_Wave2_outdf[PDS_Wave2_outdf$survey_date!="2017-12-12",]
write.csv(PDS_Wave2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave2/PDS_Wave2.csv"))

#fix PDS W1
PDS_Wave1_outdf <- rbind(PDS_Wave1_outdf,PDS_Wave1add_p1_outdf,PDS_Wave1add_p2_outdf)
write.csv(PDS_Wave1_outdf, file = paste0(workdir,"Qualtrics_Output/Wave1/PDS_Wave1.csv"))

PDS_Wave2_TAG2_outdf <- PDS_cleaned %>% filter(grepl("W2",survey_name)) %>% 
  filter(!grepl("TAG0|TAG1|TAG2",tagid)) %>% filter(!grepl("Parent",survey_name))
write.csv(PDS_Wave2_TAG2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave2/PDS_Wave2_TAG2.csv"))

PDS_Wave3_outdf <- PDS_cleaned %>% filter(grepl("W3",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid)) %>% filter(!grepl("Parent",survey_name))
write.csv(PDS_Wave3_outdf, file = paste0(workdir,"Qualtrics_Output/Wave3/PDS_Wave3.csv"))

#not yet...
PDS_Wave3_TAG2_outdf <- PDS_cleaned %>% filter(grepl("W3",survey_name)) %>% 
  filter(!grepl("TAG0|TAG1|TAG2",tagid)) %>% filter(!grepl("Parent",survey_name))
#write.csv(PDS_Wave3_TAG2_outdf, file = paste0(workdir,"Qualtrics_Output/Wave3/PDS_Wave3_TAG2.csv"))

PDS_Wave4_outdf <- PDS_cleaned %>% filter(grepl("W4",survey_name)) %>% filter(!grepl("Parent",survey_name))
write.csv(PDS_Wave4_outdf, file = paste0(workdir,"Qualtrics_Output/Wave4/PDS_Wave4.csv"))

LMP_Menarche_Wave4_outdf <- PDS_cleaned_lmp_menarche %>% filter(grepl("W4",survey_name)) %>% filter(!grepl("Parent",survey_name))
write.csv(LMP_Menarche_Wave4_outdf, file = paste0(workdir,"Qualtrics_Output/Wave4/LMP_Menarche_Only_Wave4.csv"))

PDS_Wave5_outdf <- PDS_cleaned %>% filter(grepl("W5|TAG2 W1",survey_name)) %>% 
  filter(!grepl("TAG3|TAG4",tagid)) %>% filter(!grepl("Parent",survey_name))
write.csv(PDS_Wave5_outdf, file = paste0(workdir,"Qualtrics_Output/Wave5/PDS_Wave5.csv"))

LMP_Menarche_Wave5_outdf <- PDS_cleaned_lmp_menarche %>% filter(grepl("W5",survey_name)) %>% filter(!grepl("Parent",survey_name))
write.csv(LMP_Menarche_Wave5_outdf, file = paste0(workdir,"Qualtrics_Output/Wave5/LMP_Menarche_Only_Wave5.csv"))

PDS_Wave6_outdf <- PDS_cleaned %>% filter(grepl("W6",survey_name)) %>% filter(!grepl("Parent",survey_name))
write.csv(PDS_Wave6_outdf, file = paste0(workdir,"Qualtrics_Output/Wave6/PDS_Wave6.csv"))

LMP_Menarche_Wave6_outdf <- PDS_cleaned_lmp_menarche %>% filter(grepl("W6",survey_name)) %>% filter(!grepl("Parent",survey_name))
write.csv(LMP_Menarche_Wave6_outdf, file = paste0(workdir,"Qualtrics_Output/Wave6/LMP_Menarche_Only_Wave6.csv"))

PDS_WaveSOS_outdf <- PDS_cleaned %>% filter(grepl("SOS",survey_name))
write.csv(PDS_WaveSOS_outdf, file = paste0(workdir,"Qualtrics_Output/WaveSOS/PDS_WaveSOS.csv"))

PDS_WaveACE1_outdf <- PDS_cleaned %>% filter(grepl("ACE",survey_name))
write.csv(PDS_WaveACE1_outdf, file = paste0(workdir,"Qualtrics_Output/WaveACE1/PDS_WaveACE1.csv"))

PDS_Wave1_outdf$wave <- 1
PDS_Wave1_TAG2_outdf$wave <- 1
PDS_Wave2_outdf$wave <- 2
PDS_Wave2_TAG2_outdf$wave <- 2
PDS_Wave3_outdf$wave <- 3
#PDS_Wave3_TAG2_outdf$wave <- 3
PDS_Wave4_outdf$wave <- 4
PDS_Wave5_outdf$wave <- 5
PDS_Wave6_outdf$wave <- 6
PDS_WaveSOS_outdf$wave <- "SOS"
PDS_WaveACE1_outdf$wave <- "ACE1"

#need to add tag2w3 when available to this rbind command
PDS_alldata <- rbind(PDS_Wave1_outdf,PDS_Wave2_outdf,PDS_Wave3_outdf,PDS_Wave4_outdf,PDS_Wave5_outdf,PDS_Wave6_outdf,PDS_Wave1_TAG2_outdf,PDS_Wave2_TAG2_outdf,PDS_WaveSOS_outdf,PDS_WaveACE1_outdf)

PDS_alldata <- PDS_alldata[with(PDS_alldata, order(tagid, survey_date)),]
PDS_alldata <- PDS_alldata %>% relocate(tagid, wave, survey_date)
write.csv(PDS_alldata, file = paste0(workdir,"Qualtrics_Output/Long/PDS_AllObs_Chronological.csv"))
```
