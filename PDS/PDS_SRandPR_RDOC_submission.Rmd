```{r}
## Make RDOC ready file #note - this is both self-report and parent-report data. comments field indicates which is which, as per nda guidelines
PDS_Wave1$survey_date <- as.character(PDS_Wave1$survey_date)
ndar_pds_data <- left_join(PDS_Wave1,distinct(redcap_cleaned, tagid, dob),by="tagid") %>%
  filter(!is.na(survey_date),!survey_date=="") %>%
  mutate(interview_date=paste0(sprintf("%02d",month(survey_date)),"/",sprintf("%02d",day(survey_date)),"/",year(survey_date)),
         interview_age=round((interval(start =dob, end = survey_date) / duration(num = 1, units = "months")),0),
         comments_misc=ifelse(grepl("Sess 1",survey_name),"Session1",
                              ifelse(grepl("Session 1|S1",survey_name),"Session1",
                                     ifelse(grepl("Sess 2",survey_name),"Session2",
                                            ifelse(grepl("Session 2|S2",survey_name),"Session2",
                                                   ifelse(grepl("in-lab",survey_name),"Session2", 
                                                          ifelse(grepl("Home",survey_name),"Home Questionnaires",
                                                                 ifelse(grepl("Parent",survey_name),"Parent",
                                                                        ifelse(grepl("SOS|ACE",survey_name),"substudy",NA)))))))),
         sex="F",
         respond=ifelse(grepl("Parent",survey_name),1,3),
         pds_1=PDS_F1,
         pds_2=PDS_F2,
         pds_3=PDS_F3,
         pds_6=PDS_F4,
         pds6g=PDS_F6,
         pds_7b_pv=PDS_F5,
         pds_girl_rs=999,
         pds6g=ifelse(pds6g==2, 99, pds6g)
  )

anthro$anthro_doc <- as.character.Date(anthro$anthro_doc, format = "%m/%d/%Y")

ndar_pds_data <- left_join(ndar_pds_data,anthro %>% select(tagid,weight,height,anthro_doc), by=c("tagid" = "tagid", "interview_date" = "anthro_doc")) %>%
  mutate(height_std=height,
         weight_std=weight)
ndar_pds_data <- left_join(ndar_key,ndar_pds_data, by="tagid") %>%
  mutate(src_subject_id=anontagid,
         subjectkey=guid) %>%
  filter(!is.na(subjectkey),
         !interview_age=="") %>%
  select(-contains("PDS",ignore.case = FALSE),-dob,-survey_date,-survey_type,-survey_name,-tagid,-anontagid,-ID,-guid,
         -contains("pet"),-contains("adren"),-contains("gonad"),-weight,-height,-contains("pdss", ignore.case = FALSE))
pds_df_header<-rep(NA,length(read.csv(paste0(workdir,"RDoCdb/templates/pds01_template.csv"), header = FALSE, stringsAsFactors = FALSE)))
pds_df_header[1]<-read.csv(paste0(workdir,"RDoCdb/templates/pds01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,1]
pds_df_header[2]<-read.csv(paste0(workdir,"RDoCdb/templates/pds01_template.csv"), header = FALSE, stringsAsFactors = FALSE)[1,2]

pds_temp<-as.list(read.csv(paste0(workdir,"RDoCdb/templates/pds01_template.csv"), header = TRUE, stringsAsFactors = FALSE, skip=1))
pds_temp_df<-data.frame(pds_temp)
ndar_pds_data<-rbind(pds_temp_df,ndar_pds_data)

part2<-colnames(ndar_pds_data)
part3<-as.matrix(ndar_pds_data)
colnames(part3)<-NULL
together<-rbind(pds_df_header,part2,part3)
write.table(together,file =paste0(workdir,"RDoCdb/output/jul2025/pds01.csv"),sep=",",na = "",row.names=FALSE,col.names=FALSE)
rm(pds_temp_df,pds_temp,pds_df_header,PDS_Wave1_pdss_by_age_graph,PDS_withage,PDS_Wave1_pdss_graph,
   PDS_Wave1,PDS)
```
